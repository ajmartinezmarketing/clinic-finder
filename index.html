<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Options Medical Location Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Noto+Serif:400,400italic,700italic&display=swap" rel="stylesheet">
  <style>
    body {
      background: #F7F5F2;
      font-family: 'Montserrat', Arial, sans-serif;
      color: #203B49;
      max-width: 1100px;
      margin: auto;
      padding: 24px 12px 36px 12px;
    }
    .omwl-title {
      font-size: 2.1rem;
      color: #0A4A4B;
      margin-bottom: 10px;
      font-weight: 700;
      letter-spacing: -1px;
    }
    .omwl-version {
      font-size: 13px;
      color: #888;
      margin-bottom: 18px;
    }
    #zipInput, #findBtn {
      font-family: 'Montserrat', Arial, sans-serif;
      font-size: 1rem;
      padding: 8px 12px;
      border: 1px solid #BFD3D9;
      border-radius: 5px;
      margin-right: 7px;
      background: #fff;
    }
    #findBtn {
      background: #0A4A4B;
      color: #fff;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      padding: 8px 20px;
    }
    #findBtn:hover:enabled {
      background: #203B49;
    }
    #findBtn:disabled, #zipInput:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .main-flex {
      display: flex;
      gap: 20px;
      margin-top: 18px;
    }
    .results-container {
      flex: 1.13;
      min-width: 295px;
      max-width: 480px;
    }
    .omwl-card {
      background: #fff;
      border-radius: 12px;
      border-left: 7px solid #BFD3D9;
      box-shadow: 0 2px 10px 0 rgba(32, 59, 73, 0.07);
      margin: 0 0 11px 0;
      padding: 16px 14px 12px 20px;
      position: relative;
      transition: box-shadow 0.18s;
      font-size: 1.01rem;
    }
    .omwl-card strong {
      font-size: 1.09rem;
      color: #0A4A4B;
      font-weight: 700;
    }
    .omwl-card .number-badge {
      position: absolute;
      left: -27px;
      top: 18px;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #0A4A4B;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.02rem;
      font-weight: 700;
      border: 2px solid #C9D2AC;
      box-shadow: 0 1.5px 5px #11202722;
    }
    .omwl-label {
      font-weight: bold;
      color: #203B49;
    }
    .omwl-hours-label {
      font-family: 'Noto Serif', serif;
      font-style: italic;
      color: #203B49;
      font-size: 0.92rem;
      margin-top: 7px;
      margin-bottom: 2px;
      display: block;
      font-weight: 400;
    }
    .omwl-hours-value {
      font-family: 'Noto Serif', serif;
      font-size: 0.89rem;
      font-style: italic;
      color: #112027;
      margin-bottom: 0.5em;
      word-break: break-all;
      opacity: 0.7;
    }
    .map-container {
      flex: 1;
      min-width: 300px;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin-top: 0;
    }
    #map {
      height: 325px;
      width: 100%;
      border-radius: 13px;
      border: 1.2px solid #BFD3D9;
      background: #EBF5F3;
      margin: 0;
    }
    @media (max-width: 1100px) {
      .main-flex { flex-direction: column; gap: 0; }
      .map-container, .results-container { min-width: 0; max-width: none; }
      #map { height: 240px; }
    }
    @media (max-width: 700px) {
      .omwl-title { font-size: 1.27rem; }
      .omwl-card { padding: 10px 7px 7px 13px; font-size: 0.98rem; }
      #map { height: 180px; }
    }
  </style>
</head>
<body>
  <div class="omwl-version">Version 1.8 &mdash; Updated 2024-06-08</div>
  <div class="omwl-title">Find Nearest Options Medical Clinic</div>
  <input type="text" id="zipInput" placeholder="Enter ZIP Code" disabled />
  <button id="findBtn" onclick="findClinics()" disabled>Find Clinics</button>

  <div class="main-flex">
    <div class="results-container" id="results"></div>
    <div class="map-container"><div id="map"></div></div>
  </div>

<script>
const clinics = [/* your clinics data here, unchanged */];
// For brevity, keep your clinics array as it is in your file!

function findClinics() {
  const zip = document.getElementById("zipInput").value;
  const geocoder = new google.maps.Geocoder();
  const service = new google.maps.DistanceMatrixService();
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "Loading...";

  geocoder.geocode({ address: zip }, function(results, status) {
    if (status !== "OK" || results.length === 0) {
      resultsDiv.innerHTML = "Could not find location.";
      return;
    }

    const origin = results[0].geometry.location;
    const batchSize = 25;
    let batches = [];
    for (let i = 0; i < clinics.length; i += batchSize) {
      batches.push(clinics.slice(i, i + batchSize));
    }
    let allResults = [];
    let pending = batches.length;
    let errorOccurred = false;

    batches.forEach((batch, batchIndex) => {
      service.getDistanceMatrix({
        origins: [origin],
        destinations: batch.map(c => c.address),
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.IMPERIAL
      }, function(response, status) {
        if (status !== "OK") {
          if (!errorOccurred) {
            errorOccurred = true;
            resultsDiv.innerHTML = "Error getting distances.";
          }
          return;
        }

        let destAddresses = response.destinationAddresses;
        response.rows[0].elements.forEach((element, idx) => {
          allResults.push({
            ...batch[idx],
            distance: element.distance?.text || "N/A",
            duration: element.duration?.text || "N/A",
            rawDistance: element.distance?.value || Infinity,
            __destAddr: destAddresses[idx]
          });
        });

        pending--;
        if (pending === 0 && !errorOccurred) {
          allResults.sort((a, b) => a.rawDistance - b.rawDistance);
          let html = "";
          allResults.slice(0, 5).forEach((c, i) => {
            html += `<div class="omwl-card">
              <div class="number-badge">${i+1}</div>
              <strong>${c.name}</strong><br>
                ${c.address}<br>
                <span class="omwl-label">Distance:</span> ${c.distance}<br>
                <span class="omwl-label">Drive Time:</span> ${c.duration}<br>
                <span class="omwl-hours-label">Hours of Operation</span>
                <span class="omwl-hours-value">${c.hours ? c.hours : "See website or call for details."}</span>
            </div>`;
          });
          resultsDiv.innerHTML = html;

          // Serial geocode with delay to avoid throttling
          function geocodeNext(index, coords, onDone) {
            if (index >= 5) { onDone(coords); return; }
            const geocoder2 = new google.maps.Geocoder();
            geocoder2.geocode({ address: allResults[index].__destAddr }, (results, status) => {
              if (status === "OK" && results[0]) {
                coords[index] = results[0].geometry.location;
              } else {
                coords[index] = null;
              }
              setTimeout(() => geocodeNext(index + 1, coords, onDone), 200); // 200ms delay between calls
            });
          }
          let coords = [];
          geocodeNext(0, coords, (coordsArr) => {
            showMap(origin, allResults.slice(0, 5), coordsArr);
          });
        }
      });
    });
  });
}

function showMap(origin, clinics5, coordsArr) {
  const map = new google.maps.Map(document.getElementById("map"), {
    zoom: 10,
    center: origin,
    mapTypeControl: false,
    streetViewControl: false
  });

  // Custom "You" pin (blue dot)
  const youMarker = new google.maps.Marker({
    position: origin,
    map: map,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 8,
      fillColor: "#13B1F0",
      fillOpacity: 1,
      strokeColor: "#112027",
      strokeWeight: 2
    },
    title: "You are here"
  });

  let infowindow = new google.maps.InfoWindow();

  clinics5.forEach((c, i) => {
    const latLng = coordsArr[i];
    if (!latLng) return;
    const marker = new google.maps.Marker({
      position: latLng,
      map: map,
      label: {
        text: String(i+1),
        color: "#fff",
        fontWeight: "bold",
        fontSize: "16px"
      },
      icon: {
        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
        scale: 5,
        fillColor: "#0A4A4B",
        fillOpacity: 1,
        strokeColor: "#C9D2AC",
        strokeWeight: 2
      },
      title: c.name
    });
    marker.addListener('click', function() {
      infowindow.setContent(`<div style="font-weight:600; color:#0A4A4B;">${i+1}. ${c.name}</div><div style="font-size:13px;">${c.address}</div>`);
      infowindow.open(map, marker);
    });
  });
}

// Enable UI only when Maps is loaded
function onMapsLoaded() {
  document.getElementById('zipInput').disabled = false;
  document.getElementById('findBtn').disabled = false;
}
</script>
  
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2ZRf58xsFPABXym2r1htg008auaGj6BI&callback=onMapsLoaded">
</script>
</body>
</html>
